{% extends "app/base.html" %}

{% load static %}


{% block title %}
Registrar | Expresate con señas
{% endblock %}

{% block content %}



<div class="container mx-auto p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Encabezado -->
        
    <!--formulario de registro usuarios-->
        <div class="container mx-auto p-4">
            <div class="max-w-6xl mx-auto">
                <!-- Encabezado -->
                <div class="text-center mb-8">
                    <div class="inline-block rounded-lg bg-cyan-100 px-3 py-1 text-xl text-cyan-800 font-medium mb-3">
                        REGISTRARTE
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">Comienza tu viaje hacia el bienestar</h1>
                    <p class="text-gray-600">Crea tu cuenta y personaliza tu experiencia</p>
                </div>
        
                <!-- Formulario de registro -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <!-- Columna izquierda con imagen de fondo - ocupa 2 de 5 columnas -->
                    <div class="md:col-span-2 bg-slate-800 text-white rounded-lg overflow-hidden relative shadow-xl">
                        <div class="absolute inset-0 w-full h-full">
                            <img 
                                src="https://uptechunt-dev.s3.us-west-1.amazonaws.com/1708600289471-01HQ886T5Y5VAMBD3V4F7Q2MYY.svg" 
                                alt="Persona sentada con laptop"
                                class="w-full h-full object-cover opacity-40"
                            />
                        </div>
                        <div class="relative p-6 md:p-8 space-y-4">
                            <div class="text-sm font-semibold text-cyan-400">BENEFICIOS DE REGISTRARTE</div>
                            <h2 class="text-2xl md:text-3xl font-bold">
                                Tu camino personalizado hacia el bienestar
                            </h2>
                            <ul class="space-y-4 mt-6">
                                <li class="flex items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-400 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <span>Programas adaptados a tus necesidades específicas</span>
                                </li>
                                <li class="flex items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-400 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <span>Seguimiento de tu progreso con estadísticas personalizadas</span>
                                </li>
                                <li class="flex items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-400 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <span>Acceso a nuestra comunidad de apoyo y recursos exclusivos</span>
                                </li>
                                <li class="flex items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-400 mr-2 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <span>Asesoramiento personalizado de nuestros expertos</span>
                                </li>
                            </ul>
                        </div>
                    </div>
        
                    <!-- Columna derecha con formulario - ocupa 3 de 5 columnas -->
                    <div class="md:col-span-3 bg-white rounded-lg p-6 md:p-8 shadow-lg">
                        
                        <form method="post" action="{% url 'registrarUser' %}" x-data="registrationForm()">
                            {% csrf_token %}                           
                            
                           
                            
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="mb-4 p-4 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            {% endif %}
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <!-- Nombres -->
                                <div>
                                    <label for="first_name" class="block text-sm font-medium text-gray-700 mb-1">Nombres</label>
                                    <input 
                                        type="text" 
                                        id="first_name" 
                                        name="first_name" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="Tus nombres"
                                        x-model="formData.first_name"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.first_name.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.first_name.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.first_name" class="text-red-500 text-xs mt-1" x-text="errors.first_name"></div>
                                </div>
                                
                                <!-- Apellidos -->
                                <div>
                                    <label for="last_name" class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label>
                                    <input 
                                        type="text" 
                                        id="last_name" 
                                        name="last_name" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="Tus apellidos"
                                        x-model="formData.last_name"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.last_name.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.last_name.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.last_name" class="text-red-500 text-xs mt-1" x-text="errors.last_name"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <!-- Nombre de usuario -->
                                <div>
                                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Nombre de usuario</label>
                                    <input 
                                        type="text" 
                                        id="username" 
                                        name="username" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="Elige un nombre de usuario"
                                        x-model="formData.username"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.username.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.username.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.username" class="text-red-500 text-xs mt-1" x-text="errors.username"></div>
                                </div>
                                
                                <!-- Email -->
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico</label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        name="email" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="tu@email.com"
                                        x-model="formData.email"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.email.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.email.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.email" class="text-red-500 text-xs mt-1" x-text="errors.email"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <!-- Contraseña -->
                                <div>
                                    <label for="password1" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                    <input 
                                        type="password" 
                                        id="password1" 
                                        name="password1" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="Crea una contraseña segura"
                                        x-model="formData.password1"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.password1.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.password1.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.password1" class="text-red-500 text-xs mt-1" x-text="errors.password1"></div>
                                </div>
                                
                                <!-- Confirmar contraseña -->
                                <div>
                                    <label for="password2" class="block text-sm font-medium text-gray-700 mb-1">Confirmar contraseña</label>
                                    <input 
                                        type="password" 
                                        id="password2" 
                                        name="password2" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="Repite tu contraseña"
                                        x-model="formData.password2"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.password2.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.password2.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.password2" class="text-red-500 text-xs mt-1" x-text="errors.password2"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <!-- Dispositivo de preferencia -->
                                <div>
                                    <label for="dispositivo" class="block text-sm font-medium text-gray-700 mb-1">Dispositivo de preferencia</label>
                                    <select 
                                        id="dispositivo" 
                                        name="dispositivo" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        x-model="formData.dispositivo"
                                        required
                                    >
                                        <option value="">Selecciona un dispositivo</option>
                                        <option value="smartphone">Smartphone</option>
                                        <option value="tablet">Tablet</option>
                                        <option value="laptop">Laptop</option>
                                        <option value="escritorio">Computadora de escritorio</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                    <!-- backend errors -->
                                    {% if form.dispositivo.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.dispositivo.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.dispositivo" class="text-red-500 text-xs mt-1" x-text="errors.dispositivo"></div>
                                </div>
                                
                                <!-- País -->
                                <div class="mb-4">
                                    <label for="nombrePais" class="block text-sm font-medium text-gray-700 mb-1">País</label>
                                    <input 
                                        list="countriesList"
                                        id="nombrePais" 
                                        name="nombrePais" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent bg-white text-gray-400"
                                        placeholder="Escribe o selecciona tu país"
                                        x-model="formData.nombrePais"
                                        @input="updateHiddenPaisId()"
                                        autocomplete="off"
                                        required
                                    >
                                    
                                    <input type="hidden" x-model="formData.pais" id="pais" name="pais" /><!--pais id-->
                                    <datalist id="countriesList">
                                        {% for pais in listPaises %}
                                            <option value="{{ pais.nombre }}" data-id="{{ pais.id }}">{{ pais.nombre }}</option>
                                        {% endfor %}
                                    </datalist>                                   
                                    
                                    
                                    
                                    <!-- backend errors -->
                                    {% if form.pais.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.pais.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.nombrePais" class="text-red-500 text-xs mt-1" x-text="errors.nombrePais"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <!-- Edad -->
                                <div>
                                    <label for="edad" class="block text-sm font-medium text-gray-700 mb-1">Edad</label>
                                    <input 
                                        type="number" 
                                        id="edad" 
                                        name="edad" 
                                        min="18" 
                                        max="120" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        placeholder="Tu edad"
                                        x-model="formData.edad"
                                        required
                                    >
                                    <!-- backend errors -->
                                    {% if form.edad.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.edad.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.edad" class="text-red-500 text-xs mt-1" x-text="errors.edad"></div>
                                </div>
                                
                                <!-- Rol -->
                                <div>
                                    <label for="rol" class="block text-sm font-medium text-gray-700 mb-1">Perfil/Rol</label>
                                    <select 
                                        id="rol" 
                                        name="rol" 
                                        class="capitalize w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
                                        x-model="formData.rol"
                                        required
                                    >
                                        <option value="">Selecciona tu rol</option>
                                        {% for rol in listRoles %}
                                            <option value="{{ rol.id }}">{{ rol.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <!-- backend errors -->
                                    {% if form.rol.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.rol.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <!-- fronted errors -->
                                    <div x-show="errors.rol" class="text-red-500 text-xs mt-1" x-text="errors.rol"></div>
                                </div>
                            </div>
                            
                            <div class="mb-6 flex items-center justify-between gap-4">

                                <div class="w-1/2" x-data="altchaHandler()" x-init="init()">
                                    <altcha-widget id="altcha" challengeurl="{% url 'altcha_challenge' %}"></altcha-widget>
                                    <input type="hidden" name="altcha_token"  :value="payload">
                                    <input type="hidden" name="token" id="token" x-model="formData.token">
                                </div>
                                <!-- fronted errors -->
                                <div x-show="errors.token" class="text-red-500 text-xs mt-1" x-text="errors.token"></div>
                                 <!-- backend errors -->
                                  
                                 {% if form.altcha_token.errors %}
                                    <div class="text-red-500 text-xs mt-1">
                                        {% for error in form.altcha_token.errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                

                                
                            </div>                           

                            <div class="flex mb-3 items-center">
                                <input 
                                    type="checkbox" 
                                    id="terms" 
                                    name="terms" 
                                    class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 rounded"
                                    x-model="formData.terms"
                                    :disabled="!isFormValid"
                                    x-on:change="if (!isFormValid) formData.terms = false"
                                    required
                                >
                                <label for="terms" class="ml-2 block text-sm text-gray-700">
                                    Acepto los <a href="#" class="text-cyan-600 hover:underline">términos y condiciones</a> y la <a href="#" class="text-cyan-600 hover:underline">política de privacidad</a>
                                    <div x-show="errors.terms" class="text-red-500 text-xs mt-1" x-text="errors.terms"></div>
                                     <!-- backend errors -->
                                        {% if form.terms.errors %}
                                        <div class="text-red-500 text-xs mt-1">
                                            {% for error in form.terms.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </label>                                  
                            </div>  

                            <div class="flex flex-col space-y-4">
                                <button 
                                    type="submit"
                                    x-on:click.prevent="submitForm"
                                    x-data="{ hover: false }"
                                    x-on:mouseenter="hover = true"
                                    x-on:mouseleave="hover = false"
                                    class="w-full bg-teal-500 hover:bg-teal-600 text-white font-medium px-6 py-3 rounded-md transition-transform duration-200"
                                    :class="{ 'scale-[1.02]': hover }"
                                >
                                    CREAR MI CUENTA
                                </button>
                                
                                <p class="text-center text-sm text-gray-600">
                                    ¿Ya tienes una cuenta? <a href="{% url 'login' %}" class="text-cyan-600 hover:underline">Inicia sesión aquí</a>
                                </p>
                            </div>
                        </form>

                       
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="{% static 'js/altcha.js' %}?v=2" type="module"></script>
<script>
    function altchaHandler() {
        return {
            state: 'unverified',
            payload: '',
            init() {
                const widget = document.querySelector('#altcha');
                
                widget.addEventListener('statechange', (event) => {
                    const { state, payload, error } = event.detail;
                    this.state = state;
                    
                    if (state === 'verified' && payload) {
                        this.payload = payload;
                        
                        // Actualiza el campo visible
                        document.getElementById('token').value = payload;
                        
                        // Actualiza formData.token en el contexto del formulario
                        // Usa Alpine.js global para encontrar el componente padre
                        try {
                            // Intentamos acceder al contexto del formulario
                            const formElement = this.$el.closest('form');
                            if (formElement && window.Alpine) {
                                const parentComponent = Alpine.$data(formElement);
                                if (parentComponent && parentComponent.formData) {
                                    parentComponent.formData.token = payload;
                                }
                            }
                        } catch (e) {
                            console.warn("No se pudo acceder al formulario padre:", e);
                        }
                        
                    } else {
                        this.payload = '';
                    }
                    
                    if (state === 'error') {
                        console.error('Error verificando el captcha:', error);
                    }
                });
            }
        };
    }
    function registrationForm() {
        return {
            formData: {
                first_name: "{{ form.first_name.value|default:''|escapejs }}",
                last_name: "{{ form.last_name.value|default:''|escapejs }}",
                username: "{{ form.username.value|default:''|escapejs }}",
                email: "{{ form.email.value|default:''|escapejs }}",
                password1: "",
                password2: "",
                dispositivo: "{{ form.dispositivo.value|default:''|escapejs }}",
                nombrePais: "{{ form.nombrePais.value|default:''|escapejs }}",
                pais: "{{ form.pais.value|default:''|escapejs }}",
                edad: "{{ form.edad.value|default:''|escapejs }}",
                rol: "{{ form.rol.value|default:''|escapejs }}",
                token: "{{ form.token.value|default:''|escapejs }}",
                terms: false,
                
                
            },
            errors: {},
            get isFormValid() {
                return (
                    this.formData.first_name.trim() &&
                    this.formData.last_name.trim() &&
                    this.formData.username.trim() &&
                    this.validateEmail(this.formData.email) &&
                    this.formData.password1.trim() &&
                    this.formData.password1 === this.formData.password2 &&
                    this.formData.dispositivo &&
                    this.formData.nombrePais.trim() &&
                    this.formData.edad >= 7 &&
                    this.formData.edad <= 120 &&
                    this.formData.rol &&
                    this.formData.token.trim()
                );
            },
            updateHiddenPaisId(){
                const selectedOption = document.querySelector('#countriesList option[value="' + this.formData.nombrePais + '"]');
                const idPais = selectedOption.getAttribute('data-id');

                if (selectedOption) {
                    const idPais = selectedOption.getAttribute('data-id');
                    this.formData.pais = idPais; 
                    document.getElementById('pais').value = idPais; 
                } else {
                    this.formData.pais = ''; 
                    document.getElementById('pais').value = ''; 
                }   
            },
            submitForm() {
                this.errors = {};
                let isValid = true;

                // Validación básica
                if (!this.formData.first_name.trim()) {
                    this.errors.first_name = 'Por favor ingresa tus nombres';
                    isValid = false;
                }

                if (!this.formData.last_name.trim()) {
                    this.errors.last_name = 'Por favor ingresa tus apellidos';
                    isValid = false;
                }

                if (!this.formData.username.trim()) {
                    this.errors.username = 'Por favor ingresa un nombre de usuario';
                    isValid = false;
                }

                if (!this.formData.email.trim()) {
                    this.errors.email = 'Por favor ingresa tu correo electrónico';
                    isValid = false;
                } else if (!this.validateEmail(this.formData.email)) {
                    this.errors.email = 'Por favor ingresa un correo electrónico válido';
                    isValid = false;
                }

                if (!this.formData.password1.trim()) {
                    this.errors.password = 'Por favor ingresa una contraseña';
                    isValid = false;
                }

                if (this.formData.password1 !== this.formData.password2) {
                    this.errors.password2 = 'Las contraseñas no coinciden';
                    isValid = false;
                }

                if (!this.formData.dispositivo) {
                    this.errors.dispositivo = 'Por favor selecciona un dispositivo';
                    isValid = false;
                }

                const paisOptions = Array.from(document.querySelectorAll('#countriesList option')).map(option => option.value);
                if (!paisOptions.includes(this.formData.nombrePais.trim())) {
                    this.errors.nombrePais = 'Por favor selecciona un país válido de la lista';
                    isValid = false;
                }

                if (!this.formData.edad || this.formData.edad < 7 || this.formData.edad > 120) {
                    this.errors.edad = 'Por favor ingresa una edad válida (entre 7 y 120)';
                    isValid = false;
                }

                if (!this.formData.rol) {
                    this.errors.rol = 'Por favor selecciona tu rol';
                    isValid = false;
                }
                if (!this.formData.token.trim()) {
                    this.errors.token = 'Por favor completa el captcha';
                    isValid = false;
                }

                if (!this.formData.terms) {
                    this.errors.terms = 'Debes aceptar los términos y condiciones';
                    isValid = false;
                }               

                if (!isValid) {
                    this.formData.terms = false;
                }

                if (isValid) {
                    document.querySelector('form').submit();
                }              
            },
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }
        }
    }
</script>
{% endblock %}